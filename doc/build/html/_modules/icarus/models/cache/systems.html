
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>icarus.models.cache.systems &#8212; Icarus 0.8.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/sphinxdoc.css" />
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">Icarus 0.8.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">icarus.models.cache.systems</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for icarus.models.cache.systems</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Simple networks of caches modeled as single caches.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">icarus.util</span> <span class="kn">import</span> <span class="n">inheritdoc</span>
<span class="kn">from</span> <span class="nn">icarus.tools</span> <span class="kn">import</span> <span class="n">DiscreteDist</span>
<span class="kn">from</span> <span class="nn">icarus.registry</span> <span class="kn">import</span> <span class="n">register_cache_policy</span><span class="p">,</span> <span class="n">CACHE_POLICY</span>

<span class="kn">from</span> <span class="nn">.policies</span> <span class="kn">import</span> <span class="n">Cache</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;PathCache&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TreeCache&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ArrayCache&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ShardedCache&quot;</span><span class="p">,</span>
<span class="p">]</span>


<div class="viewcode-block" id="PathCache"><a class="viewcode-back" href="../../../../apidoc/icarus.models.cache.html#icarus.models.cache.systems.PathCache">[docs]</a><span class="nd">@register_cache_policy</span><span class="p">(</span><span class="s2">&quot;PATH&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">PathCache</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Path of caches</span>

<span class="sd">    This is not a single-node cache implementation but rather it implements</span>
<span class="sd">    a path of caching nodes in which requests are fed to the first node of the</span>
<span class="sd">    path and, in case of a miss, are propagated down to the remaining nodes</span>
<span class="sd">    of the path. A miss occurs if none of the nodes on the path has the</span>
<span class="sd">    requested content.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">caches</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        caches : array-like</span>
<span class="sd">            An array of caching nodes instances on the path</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_caches</span> <span class="o">=</span> <span class="n">caches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">caches</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_len</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">maxlen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_len</span>

<div class="viewcode-block" id="PathCache.has"><a class="viewcode-back" href="../../../../apidoc/icarus.models.cache.html#icarus.models.cache.systems.PathCache.has">[docs]</a>    <span class="k">def</span> <span class="nf">has</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caches</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="PathCache.get"><a class="viewcode-back" href="../../../../apidoc/icarus.models.cache.html#icarus.models.cache.systems.PathCache.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_len</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caches</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># Put contents on all caches traversed by the retrieved content</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_caches</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="PathCache.put"><a class="viewcode-back" href="../../../../apidoc/icarus.models.cache.html#icarus.models.cache.systems.PathCache.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Insert an item in the cache if not already inserted.</span>

<span class="sd">        If the element is already present in the cache, it will pushed to the</span>
<span class="sd">        top of the cache.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        k : any hashable type</span>
<span class="sd">            The item to be inserted</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        evicted : any hashable type</span>
<span class="sd">            The evicted object or *None* if no contents were evicted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caches</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">k</span><span class="p">)</span></div>

<div class="viewcode-block" id="PathCache.remove"><a class="viewcode-back" href="../../../../apidoc/icarus.models.cache.html#icarus.models.cache.systems.PathCache.remove">[docs]</a>    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;This method is not implemented&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PathCache.position"><a class="viewcode-back" href="../../../../apidoc/icarus.models.cache.html#icarus.models.cache.systems.PathCache.position">[docs]</a>    <span class="k">def</span> <span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;This method is not implemented&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PathCache.dump"><a class="viewcode-back" href="../../../../apidoc/icarus.models.cache.html#icarus.models.cache.systems.PathCache.dump">[docs]</a>    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serialized</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">dump</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caches</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">dump</span><span class="p">,</span> <span class="p">[])</span> <span class="k">if</span> <span class="n">serialized</span> <span class="k">else</span> <span class="n">dump</span></div>

<div class="viewcode-block" id="PathCache.clear"><a class="viewcode-back" href="../../../../apidoc/icarus.models.cache.html#icarus.models.cache.systems.PathCache.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caches</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="TreeCache"><a class="viewcode-back" href="../../../../apidoc/icarus.models.cache.html#icarus.models.cache.systems.TreeCache">[docs]</a><span class="nd">@register_cache_policy</span><span class="p">(</span><span class="s2">&quot;TREE&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TreeCache</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Path of caches</span>

<span class="sd">    This is not a single-node cache implementation but rather it implements</span>
<span class="sd">    a tree of caching nodes in which requests are fed to a random leaf node</span>
<span class="sd">    and, in case of a miss, are propagated down to the remaining nodes</span>
<span class="sd">    of the path. A miss occurs if none of the nodes on the path has the</span>
<span class="sd">    requested content.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This cache can only be operated in a read-through manner and not in write</span>
<span class="sd">    through or read/write aside. In other words, before issuing a put, you</span>
<span class="sd">    must issue a get for the same item. The reason for this limitation is</span>
<span class="sd">    to ensure that matching get/put requests go through the same randomly</span>
<span class="sd">    selected node.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">leaf_caches</span><span class="p">,</span> <span class="n">root_cache</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        caches : array-like</span>
<span class="sd">            An array of caching nodes instances on the path</span>
<span class="sd">        segments : int</span>
<span class="sd">            The number of segments</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_leaf_caches</span> <span class="o">=</span> <span class="n">leaf_caches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_root_cache</span> <span class="o">=</span> <span class="n">root_cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">leaf_caches</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">root_cache</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_leaves</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">leaf_caches</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_leaf</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_len</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">maxlen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_len</span>

<div class="viewcode-block" id="TreeCache.has"><a class="viewcode-back" href="../../../../apidoc/icarus.models.cache.html#icarus.models.cache.systems.TreeCache.has">[docs]</a>    <span class="k">def</span> <span class="nf">has</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;This method is not implemented&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TreeCache.get"><a class="viewcode-back" href="../../../../apidoc/icarus.models.cache.html#icarus.models.cache.systems.TreeCache.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_leaf</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_leaf_caches</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_leaf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_leaf</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="TreeCache.put"><a class="viewcode-back" href="../../../../apidoc/icarus.models.cache.html#icarus.models.cache.systems.TreeCache.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Insert an item in the cache if not already inserted.</span>

<span class="sd">        If the element is already present in the cache, it will pushed to the</span>
<span class="sd">        top of the cache.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        k : any hashable type</span>
<span class="sd">            The item to be inserted</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        evicted : any hashable type</span>
<span class="sd">            The evicted object or *None* if no contents were evicted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_leaf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;You are trying to insert an item not requested before. &quot;</span>
                <span class="s2">&quot;Tree cache can be used in read-through mode only&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_leaf</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_root_cache</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">k</span><span class="p">)</span></div>

<div class="viewcode-block" id="TreeCache.remove"><a class="viewcode-back" href="../../../../apidoc/icarus.models.cache.html#icarus.models.cache.systems.TreeCache.remove">[docs]</a>    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;This method is not implemented&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TreeCache.position"><a class="viewcode-back" href="../../../../apidoc/icarus.models.cache.html#icarus.models.cache.systems.TreeCache.position">[docs]</a>    <span class="k">def</span> <span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;This method is not implemented&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TreeCache.dump"><a class="viewcode-back" href="../../../../apidoc/icarus.models.cache.html#icarus.models.cache.systems.TreeCache.dump">[docs]</a>    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serialized</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">dump</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_leaf_caches</span><span class="p">]</span>
        <span class="n">dump</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root_cache</span><span class="o">.</span><span class="n">dump</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">dump</span><span class="p">,</span> <span class="p">[])</span> <span class="k">if</span> <span class="n">serialized</span> <span class="k">else</span> <span class="n">dump</span></div>

<div class="viewcode-block" id="TreeCache.clear"><a class="viewcode-back" href="../../../../apidoc/icarus.models.cache.html#icarus.models.cache.systems.TreeCache.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caches</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="ArrayCache"><a class="viewcode-back" href="../../../../apidoc/icarus.models.cache.html#icarus.models.cache.systems.ArrayCache">[docs]</a><span class="nd">@register_cache_policy</span><span class="p">(</span><span class="s2">&quot;ARRAY&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ArrayCache</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Array of caches</span>

<span class="sd">    This is not a single-node cache implementation but rather it implements</span>
<span class="sd">    an array of caching nodes in which requests are fed to a random node of</span>
<span class="sd">    a set.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This cache can only be operated in a read-through manner and not in write</span>
<span class="sd">    through or read/write aside. In other words, before issuing a put, you</span>
<span class="sd">    must issue a get for the same item. The reason for this limitation is</span>
<span class="sd">    to ensure that matching get/put requests go through the same randomly</span>
<span class="sd">    selected node.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">caches</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        caches : array-like</span>
<span class="sd">            An array of caching nodes instances on the array</span>
<span class="sd">        weights : array-like</span>
<span class="sd">            Random weights according to which a cache of the array should be</span>
<span class="sd">            selected to process a given request</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_caches</span> <span class="o">=</span> <span class="n">caches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">caches</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_caches</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">caches</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selected_cache</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0001</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;weights must sum up to 1&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_caches</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;weights must have as many elements as nr of caches&quot;</span><span class="p">)</span>
            <span class="n">randvar</span> <span class="o">=</span> <span class="n">DiscreteDist</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">select_cache</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caches</span><span class="p">[</span><span class="n">randvar</span><span class="o">.</span><span class="n">rv</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">select_cache</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caches</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_len</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">maxlen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_len</span>

<div class="viewcode-block" id="ArrayCache.has"><a class="viewcode-back" href="../../../../apidoc/icarus.models.cache.html#icarus.models.cache.systems.ArrayCache.has">[docs]</a>    <span class="k">def</span> <span class="nf">has</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;This method is not implemented&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ArrayCache.get"><a class="viewcode-back" href="../../../../apidoc/icarus.models.cache.html#icarus.models.cache.systems.ArrayCache.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selected_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_cache</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span></div>

<div class="viewcode-block" id="ArrayCache.put"><a class="viewcode-back" href="../../../../apidoc/icarus.models.cache.html#icarus.models.cache.systems.ArrayCache.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Insert an item in the cache if not already inserted.</span>

<span class="sd">        If the element is already present in the cache, it will pushed to the</span>
<span class="sd">        top of the cache.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        k : any hashable type</span>
<span class="sd">            The item to be inserted</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        evicted : any hashable type</span>
<span class="sd">            The evicted object or *None* if no contents were evicted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_cache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;You are trying to insert an item not requested before. &quot;</span>
                <span class="s2">&quot;Array cache can be used in read-through mode only&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selected_cache</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">k</span><span class="p">)</span></div>

<div class="viewcode-block" id="ArrayCache.remove"><a class="viewcode-back" href="../../../../apidoc/icarus.models.cache.html#icarus.models.cache.systems.ArrayCache.remove">[docs]</a>    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;This method is not implemented&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ArrayCache.position"><a class="viewcode-back" href="../../../../apidoc/icarus.models.cache.html#icarus.models.cache.systems.ArrayCache.position">[docs]</a>    <span class="k">def</span> <span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;This method is not implemented&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ArrayCache.dump"><a class="viewcode-back" href="../../../../apidoc/icarus.models.cache.html#icarus.models.cache.systems.ArrayCache.dump">[docs]</a>    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serialized</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">dump</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caches</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">dump</span><span class="p">,</span> <span class="p">[])</span> <span class="k">if</span> <span class="n">serialized</span> <span class="k">else</span> <span class="n">dump</span></div>

<div class="viewcode-block" id="ArrayCache.clear"><a class="viewcode-back" href="../../../../apidoc/icarus.models.cache.html#icarus.models.cache.systems.ArrayCache.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caches</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="ShardedCache"><a class="viewcode-back" href="../../../../apidoc/icarus.models.cache.html#icarus.models.cache.systems.ShardedCache">[docs]</a><span class="nd">@register_cache_policy</span><span class="p">(</span><span class="s2">&quot;SHARD&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ShardedCache</span><span class="p">(</span><span class="n">Cache</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set of sharded caches.</span>

<span class="sd">    Set of caches coordinately storing items. When a request reaches the</span>
<span class="sd">    caches, the request is forwarded to the specific cache (shard) based on the</span>
<span class="sd">    outcome of a hash function. So, an item can be stored only by a single</span>
<span class="sd">    node of the system.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="s2">&quot;LRU&quot;</span><span class="p">,</span> <span class="n">nodes</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">f_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">policy_attr</span><span class="o">=</span><span class="p">{},</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        maxlen : int</span>
<span class="sd">            The maximum number of items the cache can store.</span>
<span class="sd">        policy : str, optional</span>
<span class="sd">            The eviction policy of each node (e.g., LRU, LFU, FIFO...).</span>
<span class="sd">            Default is LRU.</span>
<span class="sd">        nodes : int, optional</span>
<span class="sd">            The number of nodes, default is 4.</span>
<span class="sd">        f_map : callable, optional</span>
<span class="sd">            A callable governing the mapping between items and caching nodes.</span>
<span class="sd">            It receives as argument a value of an item :math:`k` and returns an</span>
<span class="sd">            integer between :math:`0` and :math:`nodes - 1` identifying the</span>
<span class="sd">            target node.</span>
<span class="sd">            If not specified, the mapping is done by computing the hash of the</span>
<span class="sd">            given item modulo the number of nodes.</span>
<span class="sd">        policy_attr : dict, optional</span>
<span class="sd">            A set of parameters for initializing the underlying caching policy.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The maxlen parameter refers to the cumulative size of the caches in the</span>
<span class="sd">        set. The size of each shard is derived dividing maxlen by the number</span>
<span class="sd">        of nodes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">maxlen</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">maxlen</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">maxlen</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;maxlen must be positive&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">nodes</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">nodes</span> <span class="o">&gt;</span> <span class="n">maxlen</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;nodes must be an integer and 0 &lt; nodes &lt;= maxlen&quot;</span><span class="p">)</span>
        <span class="c1"># If maxlen is not a multiple of nodes, then some nodes have one slot</span>
        <span class="c1"># more than others</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_node_maxlen</span> <span class="o">=</span> <span class="p">[</span><span class="n">maxlen</span> <span class="o">//</span> <span class="n">nodes</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nodes</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxlen</span> <span class="o">%</span> <span class="n">nodes</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_node_maxlen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_maxlen</span> <span class="o">=</span> <span class="n">maxlen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_node</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">CACHE_POLICY</span><span class="p">[</span><span class="n">policy</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">_node_maxlen</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">**</span><span class="n">policy_attr</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_map</span> <span class="o">=</span> <span class="n">f_map</span> <span class="k">if</span> <span class="n">f_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="nb">hash</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">%</span> <span class="n">nodes</span>

    <span class="nd">@inheritdoc</span><span class="p">(</span><span class="n">Cache</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_node</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">maxlen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maxlen</span>

<div class="viewcode-block" id="ShardedCache.has"><a class="viewcode-back" href="../../../../apidoc/icarus.models.cache.html#icarus.models.cache.systems.ShardedCache.has">[docs]</a>    <span class="nd">@inheritdoc</span><span class="p">(</span><span class="n">Cache</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">has</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_node</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">f_map</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">k</span><span class="p">)</span></div>

<div class="viewcode-block" id="ShardedCache.get"><a class="viewcode-back" href="../../../../apidoc/icarus.models.cache.html#icarus.models.cache.systems.ShardedCache.get">[docs]</a>    <span class="nd">@inheritdoc</span><span class="p">(</span><span class="n">Cache</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_node</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">f_map</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span></div>

<div class="viewcode-block" id="ShardedCache.put"><a class="viewcode-back" href="../../../../apidoc/icarus.models.cache.html#icarus.models.cache.systems.ShardedCache.put">[docs]</a>    <span class="nd">@inheritdoc</span><span class="p">(</span><span class="n">Cache</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_node</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">f_map</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">k</span><span class="p">)</span></div>

<div class="viewcode-block" id="ShardedCache.dump"><a class="viewcode-back" href="../../../../apidoc/icarus.models.cache.html#icarus.models.cache.systems.ShardedCache.dump">[docs]</a>    <span class="nd">@inheritdoc</span><span class="p">(</span><span class="n">Cache</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serialized</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">dump</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_node</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">dump</span><span class="p">,</span> <span class="p">[])</span> <span class="k">if</span> <span class="n">serialized</span> <span class="k">else</span> <span class="n">dump</span></div>

<div class="viewcode-block" id="ShardedCache.remove"><a class="viewcode-back" href="../../../../apidoc/icarus.models.cache.html#icarus.models.cache.systems.ShardedCache.remove">[docs]</a>    <span class="nd">@inheritdoc</span><span class="p">(</span><span class="n">Cache</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_node</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">f_map</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">k</span><span class="p">)</span></div>

<div class="viewcode-block" id="ShardedCache.clear"><a class="viewcode-back" href="../../../../apidoc/icarus.models.cache.html#icarus.models.cache.systems.ShardedCache.clear">[docs]</a>    <span class="nd">@inheritdoc</span><span class="p">(</span><span class="n">Cache</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_node</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">Icarus 0.8.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">icarus.models.cache.systems</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Lorenzo Saino, Ioannis Psaras.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.1.1.
    </div>
  </body>
</html>